name: OpenTofu Plan
description: OpenTofu Plan
author: Cupel
branding: 
  icon: box
  color: orange

inputs:
  artifact-name:
    description: The name of the published artifact that includes the plan file. If the value isn't supplied then plan will not be uploaded.
    required: false
  init-args:
    description: Additional arguments for init command. 
    required: false
  plan-args:
    description: Additional arguments for plan command.
    required: false
  use-primary-backend:
    description: A flag to indicate if the primary backend should be used.
    required: true
    default: 'true'
  version:
    description: The version of OpenTofu to install.
    required: true
    default: '1.8.1'
  working-directory:
    description: Directory that contains the OpenTofu code.
    required: true
    default: './infrastructure'
  workspace:
    description: The workspace name. If the workspace doesn't exist it will be created.
    required: true

runs:
  using: composite
  steps:
    - name: Install OpenTofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: ${{ inputs.version }}
    - name: Init
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        tofu init -no-color -lockfile=readonly -lock=false -var "use_primary_backend=${{ inputs.use-primary-backend }}" ${{ inputs.init-args }}
      env:
        TF_IN_AUTOMATION: 1
        TF_INPUT: 0
    - name: Select workspace
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        tofu workspace select -or-create=true "${{ inputs.workspace }}"
      env:
        TF_IN_AUTOMATION: 1
        TF_INPUT: 0
    - name: Plan
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        tofu plan -no-color -out="plan.tfplan" -var "use_primary_backend=${{ inputs.use-primary-backend }}" ${{ inputs.plan-args }}
      env:
        TF_IN_AUTOMATION: 1
        TF_INPUT: 0
    - name: Publish ${{ inputs.artifact-name }}
      if: ${{ inputs.artifact-name != '' }}
      uses: cupel-co/actions/artifact/upload@v0.5.0
      with:
        name: ${{ inputs.artifact-name }}
        overwrite: true
        path: ${{ inputs.working-directory }}
        retention-days: 1
